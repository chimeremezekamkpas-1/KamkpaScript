<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KamkpaScript Interpreter</title>
  <style>
    body {
      font-family: monospace;
      margin: 0;
      padding: 0;
      background: #1e1e1e;
      color: lime;
    }
    textarea {
      width: 100%;
      height: 180px;
      font-size: 15px;
      background: #111;
      color: #0f0;
      border: none;
      padding: 10px;
      outline: none;
      resize: none;
    }
    .controls {
      display: flex;
      gap: 5px;
    }
    button {
      flex: 1;
      padding: 12px;
      background: #00bfff;
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }
    input[type="file"] {
      display: none;
    }
    iframe {
      width: 100%;
      height: 400px;
      border: none;
      background: white;
    }
  </style>
</head>
<body>

  <h2 style="text-align:center;">üíª KamkpaScript (.ks) Editor</h2>

  <div class="controls">
    <button onclick="document.getElementById('fileInput').click()">üìÇ Load</button>
    <button onclick="saveFile()">üíæ Save</button>
    <button onclick="saveAsFile()">üíæ Save As</button>
    <button onclick="document.getElementById('fileInput').click()">
    <button onclick="savePreviewAsKS()">üíæ Save Preview</button>
  </div>

  <input type="file" id="fileInput" accept=".ks">

  <textarea id="ksCode">
p.type = 'web page'
title = 'Day in a life'
background-color = 'blue'
header-color = 'white'
header-text = 'Day in a life'
paragraph = 'Welcome to my first KamkpaScript webpage.'
footer-color = 'black'
footer-text = '¬© 2025 KamkpaScript'
  </textarea>

<button onclick="runKamkpaScript()">‚ñ∂Ô∏è Run KamkpaScript</button>
  <iframe id="outputFrame"></iframe>

  <script>
    /************************************
     * üìÅ Load .ks File from Storage
     ************************************/
    document.getElementById('fileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('ksCode').value = e.target.result;
      };
      reader.readAsText(file);
    });
    
    /************************************
     * üíæ Save (using last file name)
     ************************************/
    function saveFile() {
      const code = document.getElementById("ksCode").value;
      downloadFile(lastFileName, code);
    }

    /************************************
     * üíæ Save As (ask for new name)
     ************************************/
    function saveAsFile() {
      const code = document.getElementById("ksCode").value;
      const newName = prompt("Enter file name (without extension):", "myProject");
      if (newName) {
        lastFileName = newName.endsWith(".ks") ? newName : newName + ".ks";
        downloadFile(lastFileName, code);
      }
    }
    
    /************************************
     * üß© Download Helper (browser-safe)
     ************************************/
    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
      alert("‚úÖ File saved successfully as " + filename);
    }
    
    function savePreview() {
  const frame = document.getElementById('outputFrame'); // your preview iframe
  const html = frame.srcdoc;

  // Create a Blob (HTML file)
  const blob = new Blob([html], { type: 'text/html' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);

  // Default name (you can adjust)
  link.download = 'KamkpaPreview.html';
  link.click();

  // Cleanup
  URL.revokeObjectURL(link.href);
  alert("‚úÖ Preview saved as HTML file successfully!");
}  

    /************************************
     * ‚ñ∂Ô∏è KamkpaScript Interpreter Core
     ************************************/
    function runKamkpaScript() {
  const code = document.getElementById('ksCode').value;
  const lines = code.trim().split('\n');
  const settings = {};

  // Parse .ks file lines into key-value pairs
  for (let line of lines) {
    if (!line.includes('=')) continue;
    let [key, value] = line.split('=');
    key = key.trim().replace(/^p\./, 'p_');
    key = key.replace(/-/g, '_');
    value = value.trim().replace(/['"]/g, '');
    settings[key] = value;
  }

  const projectType = settings.p_type;
  let html = "";

  // üß± Web Page Logic
  if (projectType === 'web page') {
    html += `
    <html>
      <head><title>${settings.title || ''}</title></head>
      <body style="background:${settings.background_color || 'white'};margin:0;font-family:Arial;">
        <h1 style="color:${settings.header_color || 'black'};text-align:center;padding:20px;">
          ${settings.header_text || settings.title || ''}
        </h1>
        <p style="text-align:center;font-size:18px;">${settings.paragraph || ''}</p>
        <footer style="background:${settings.footer_color || 'gray'};color:white;text-align:center;padding:10px;position:fixed;bottom:0;width:100%;">
          ${settings.footer_text || ''}
        </footer>
      </body>
    </html>`;
  }

  // ü§ñ AI Logic Mode
  else if (projectType === 'ai logic') {
    html += `
    <html>
      <body style="font-family:monospace; background:black; color:lime; padding:20px;">
        <h2>ü§ñ Kamkpas AI Logic Console</h2>
        <p>Input: ${settings.input || 'No input provided'}</p>
        <p>Output: ${
          settings.input
            ? settings.input.split('').reverse().join('')
            : 'AI logic placeholder'
        }</p>
      </body>
    </html>`;
  }
  
  else if (projectType && projectType.trim().toLowerCase() === "chatbot") {

  frame.srcdoc = `
  <html>
  <head>
    <style>
      body {
        background: ${settings.background_color || "black"};
        color: white;
        font-family: Arial, sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      header {
        background: #222;
        color: lime;
        padding: 10px;
        text-align: center;
        font-size: 20px;
        border-bottom: 2px solid lime;
      }
      #chatArea {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .user {
        align-self: flex-end;
        background: lime;
        color: black;
        padding: 8px 12px;
        border-radius: 15px 15px 0 15px;
        max-width: 70%;
      }
      .bot {
        align-self: flex-start;
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 15px 15px 15px 0;
        max-width: 70%;
      }
      #inputArea {
        display: flex;
        padding: 10px;
        background: #111;
        border-top: 1px solid #444;
      }
      #userMsg {
        flex: 1;
        background: #222;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 10px;
        outline: none;
      }
      #sendBtn {
        background: lime;
        color: black;
        border: none;
        padding: 10px 15px;
        margin-left: 10px;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header>${settings.header_text || "AI Chatbot"}</header>
    <div id="chatArea"></div>
    <div id="inputArea">
      <input id="userMsg" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </body>
  </html>`;

  frame.onload = () => {
    const doc = frame.contentDocument;
    const chatArea = doc.getElementById("chatArea");
    const input = doc.getElementById("userMsg");
    const sendBtn = doc.getElementById("sendBtn");

    let chatMemory = []; // store the last few messages

    function appendMessage(sender, message) {
      const msgDiv = doc.createElement("div");
      msgDiv.className = sender === "user" ? "user" : "bot";
      msgDiv.textContent = message;
      chatArea.appendChild(msgDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
      chatMemory.push({ sender, message });
      if (chatMemory.length > 10) chatMemory.shift(); // keep only last 10
    }

    function generateReply(userMsg) {
      const lowerMsg = userMsg.toLowerCase();

      // Simple memory-based logic
      if (chatMemory.some(m => m.message.toLowerCase() === lowerMsg)) {
        return "You already said that before.";
      }
      if (lowerMsg.includes("how are you")) {
        return "I'm doing fine, still learning more from you!";
      }
      if (lowerMsg.includes("who are you")) {
        return "I'm Kamkpa AI, built with KamkpaScript ‚Äî still growing.";
      }
      if (lowerMsg.includes("remember")) {
        return "Of course, I remember our past chats!";
      }

      // If memory has a pattern of similar words
      const lastUser = chatMemory.filter(m => m.sender === "user").slice(-2).map(m => m.message.toLowerCase());
      if (lastUser.some(msg => msg.includes("life") && lowerMsg.includes("life"))) {
        return "Life seems to be an important topic to you lately.";
      }

      // Default random reply
      const replies = [
        "That‚Äôs interesting!",
        "Tell me more...",
        "I see what you mean.",
        "Hmm, continue.",
        "You mentioned something like that earlier.",
        "That makes sense!"
      ];
      return replies[Math.floor(Math.random() * replies.length)];
    }

    function sendMsg() {
      const msg = input.value.trim();
      if (!msg) return;
      appendMessage("user", msg);
      input.value = "";

      setTimeout(() => {
        const reply = generateReply(msg);
        appendMessage("bot", reply);
      }, 600);
    }

    sendBtn.onclick = sendMsg;
    input.addEventListener("keypress", e => {
      if (e.key === "Enter") sendMsg();
    });
  };
}



  // üéÆ Game Logic Mode
  else if (projectType === 'game logic') {
    html += `
    <html>
      <body style="background:#223; color:#0f0; text-align:center; font-family:monospace;">
        <h2>üéÆ Kamkpas Game Logic Test</h2>
        <p>Game Name: ${settings.title || 'Untitled Game'}</p>
        <p>Logic: ${settings.logic || 'No game logic defined'}</p>
        <p>Status: Running basic simulation...</p>
      </body>
    </html>`;
  }

  // üåê Web Scraper Logic
  else if (projectType === 'scraper') {
    html += `
    <html>
      <body style="background:#222; color:#0f0; font-family:monospace;">
        <h2>üåê KamkpaScript Web Scraper</h2>
        <p>Target URL: ${settings.url || 'No URL provided'}</p>
        <p>Scrape Target: ${settings.target || 'N/A'}</p>
        <p>Note: Actual scraping not supported in browser mode, but logic simulated.</p>
      </body>
    </html>`;
  }
  
  // üï∑Ô∏è Web Crawler Logic
  else if (projectType === 'web crawler' || projectType === 'crawler') {
    html += `
    <html>
      <body style="
        background:${settings.background_color || '#000'};
        color:${settings.text_color || 'lime'};
        font-family:monospace;
        padding:20px;
      ">
        <h2>üï∑Ô∏è KamkpaScript Web Crawler</h2>
        <p><strong>Project Title:</strong> ${settings.title || 'Untitled Crawler'}</p>
        <p><strong>Target URL:</strong> ${settings.target_url || 'https://example.com'}</p>
        <p><strong>Max Depth:</strong> ${settings.max_depth || '3'}</p>
        <p><strong>Mode:</strong> ${settings.crawl_mode || 'links only'}</p>
        <hr>
        <div id="crawlResults" style="margin-top:10px;white-space:pre-line;"></div>

        <script>
          const crawlResults = document.getElementById("crawlResults");
          const startURL = "${settings.target_url || 'https://example.com'}";
          const links = [
            startURL + "/about",
            startURL + "/contact",
            startURL + "/products",
            startURL + "/blog",
            startURL + "/faq"
          ];

          let i = 0;
          function displayNextLink() {
            if (i < links.length) {
              const link = document.createElement('a');
              link.href = links[i];
link.target = "_blank"; // open real site in new tab
link.textContent = links[i];
link.style.color = 'aqua';
link.onclick = () => {
  const note = document.createElement('div');
  note.textContent = "üï∏Ô∏è Crawling: " + links[i] + " ... opening site...";
  note.style.color = '#0f0';
  crawlResults.appendChild(note);
};
              const line = document.createElement('div');
              line.appendChild(link);
              crawlResults.appendChild(line);
              i++;
              setTimeout(displayNextLink, 800);
            } else {
              const doneMsg = document.createElement('p');
              doneMsg.textContent = "\\n‚úÖ Crawling completed up to depth ${settings.max_depth || '3'}.";
              doneMsg.style.color = 'lime';
              crawlResults.appendChild(doneMsg);
            }
          }
          displayNextLink();
        <\/script>
      </body>
    </html>`;
  }
  
  // üß© KamkpaScript Web Scraper ‚Äî Clickable Data + JSON Export
  else if (projectType === 'web scraper' || projectType === 'scraper') {
    html += `
    <html>
      <body style="
        background:${settings.background_color || '#000'};
        color:${settings.text_color || 'lime'};
        font-family:monospace;
        padding:20px;
      ">
        <h2>üï∑Ô∏è KamkpaScript Web Scraper (Clickable Version)</h2>
        <p><strong>Project Title:</strong> ${settings.title || 'Unnamed Scraper'}</p>
        <p><strong>Target URLs:</strong></p>
        <ul id="urlList" style="list-style:none;padding-left:10px;"></ul>
        <p><strong>Scrape Mode:</strong> ${settings.scrape_mode || 'contents'}</p>
        <p><strong>Max Depth:</strong> ${settings.max_depth || '1'}</p>
        <hr>
        <div id="scrapeOutput" style="margin-top:10px;white-space:pre-line;"></div>
        <button id="saveBtn" style="margin-top:20px;background:lime;color:black;padding:10px 15px;border:none;cursor:pointer;border-radius:5px;font-weight:bold;">
          üíæ Save Results (.json)
        </button>

        <script>
          const out = document.getElementById('scrapeOutput');
          const urlList = document.getElementById('urlList');
          const saveBtn = document.getElementById('saveBtn');
          const urls = ("${settings.target_url || 'https://example.com'}")
            .split(',')
            .map(u => u.trim())
            .filter(Boolean);

          const mode = ("${settings.scrape_mode || 'contents'}").toLowerCase();

          // üß† Fake scraped data generator
          function simulateScrape(url) {
            const base = new URL(url);
            return {
              url: url,
              title: "Sample Title from " + base.hostname,
              meta: "Meta description for " + base.hostname + " ‚Äî simulated content.",
              images: [
                base.origin + "/img/banner.jpg",
                base.origin + "/img/logo.png"
              ],
              links: [
                base.origin + "/about",
                base.origin + "/contact"
              ]
            };
          }

          const allResults = [];

          urls.forEach(u => {
            const li = document.createElement('li');
            li.innerHTML = '<a href="' + u + '" target="_blank" style="color:deepskyblue;">' + u + '</a>';
            urlList.appendChild(li);
          });

          let current = 0;

          function scrapeNext() {
            if (current >= urls.length) {
              out.innerHTML += "<br>‚úÖ All scraping completed successfully.";
              saveBtn.style.display = "inline-block";
              return;
            }

            const u = urls[current];
            out.innerHTML += "<br>üåê Scraping <span style='color:deepskyblue;'>" + u + "</span><br>----------------------------<br>";
            setTimeout(() => {
              const data = simulateScrape(u);
              allResults.push(data);

              // üß© Display scraped data (Clickable)
              out.innerHTML += "<strong>[Title]</strong> " + data.title + "<br>";
              out.innerHTML += "<strong>[Meta]</strong> " + data.meta + "<br>";

              // Clickable images
              out.innerHTML += "<strong>[Images]</strong><br>";
              data.images.forEach(img => {
                out.innerHTML += '<a href="' + img + '" target="_blank" style="color:yellow;">üñºÔ∏è ' + img + '</a><br>';
              });

              // Clickable links
              out.innerHTML += "<strong>[Links]</strong><br>";
              data.links.forEach(link => {
                out.innerHTML += '<a href="' + link + '" target="_blank" style="color:cyan;">üîó ' + link + '</a><br>';
              });

              out.innerHTML += "<br>";

              current++;
              scrapeNext();
            }, 1000);
          }

          // Start scraping simulation
          out.innerHTML = "üîç Starting KamkpaScript Web Scraper (Clickable Mode)...<br>";
          scrapeNext();

          // üíæ Save as JSON file
          saveBtn.onclick = () => {
            const blob = new Blob([JSON.stringify(allResults, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'scrape_results.json';
            link.click();
          };

          saveBtn.style.display = "none";
        <\/script>
      </body>
    </html>`;
  }

  // ‚ùå Unknown Type
  else {
    html = `<html><body><h2 style="text-align:center;">Unknown Project Type: ${projectType}</h2></body></html>`;
  }

  // Render result
  const outputFrame = document.getElementById('outputFrame');
  outputFrame.srcdoc = html;
}
  </script>

</body>
</html>